---
title: "Cleaner Notebook"
output: html_notebook
---
```{r FUNCTIONS Definition}
Remove.WhiteSpace <- function(x, dat) {
  return( gsub("[[:space:]]", "", dat[(x)]) )
}
```


```{r adds TransplantID to old REDCap db}
txp = merge(txp1, PPMR, by.x = "record_id", by.y= "PPMR_ID", all.x= TRUE)
#REDCap = data.frame(
  txp$TransplantID = as.character(txp$TransplantID)
```


# HERLIHY
## History of Present Illness
### Symptoms
* Chief complaint
* herli_cc
* QUESTION #1
```{r parsing free-text for keywords to categorize chief complaint}
txp$what_are_the_main_concerns_that_prompted_your_visit_today[txp$what_are_the_main_concerns_that_prompted_your_visit_today == "N/A"] = NA
txp$herli_cc = ifelse(txp$what_are_the_main_concerns_that_prompted_your_visit_today == "",NA,ifelse(grepl ("SOB",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)) | grepl ("SHORTNESS",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)) | grepl ("BREATH",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)), 1, ifelse (grepl ("COUGH", toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)),2, ifelse(                     grepl("OXYGEN",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)),3,99))))

txp$cc_spec = ifelse(REDCap$herli_cc == 99, txp$what_are_the_main_concerns_that_prompted_your_visit_today,NA)
```

* One disease that brought you to clinic?
* herli_cc_disease
* QUESTION #2
```{r parsing free_text for keywords to categorize ONE DISEASE}
txp$herli_cc_disease = ifelse(txp$what_are_the_main_concerns_that_prompted_your_visit_today == "",NA, ifelse(grepl("COPD",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)) | grepl("EMPHYSEMA",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)) | grepl("OBSTRUCTIVE",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)), 1,
                      ifelse(grepl("ASTHMA",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)),2,
                      ifelse(grepl("PAH",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)) | grepl("HYPERTENSION",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)) | grepl("PRESSURE",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)),3,
                      ifelse(grepl("FIBROSIS",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)) | grepl("IPF",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)),6,
                      ifelse(grepl("TRANSPLANT",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)) | grepl("PRE-TRANS",toupper(txp$what_are_the_main_concerns_that_prompted_your_visit_today)) ,5, 99))))))

txp$cc_disease_spec = ifelse(REDCap$herli_cc_disease == 99, txp$what_are_the_main_concerns_that_prompted_your_visit_today,NA)
```

#### Do you usually have a cough? 
* CHANGES REQ - <blanks exist>
* do_you_usually_have_a_cough *OLD*
* cough_yn *NEW*
```{r OLD-21 NEW-92}
txp$cough_yn = txp$do_you_usually_have_a_cough
txp$cough_yn[txp$cough_yn == ""] = NA
```



#### Do you usually bring up phlemgm fro your chest?
* CHANGES REQ - <blanks exist>
* do_you_usually_bring_up_phlegm_from_your_chest *OLD*
* phlegm_yn *NEW*
* LOGIC ERRORS - recode phlegm = "Yes" WHEN cough = "No" ==> chg/2 NA
```{r}
txp$phlegm_yn = txp$do_you_usually_bring_up_phlegm_from_your_chest
txp$phlegm_yn[txp$phlegm_yn == "" | txp$cough_yn == 0] = NA
# Have you had a cough with phlegm on most days for at least 3 mo over last 2 years?
txp$phlegm_yn = txp$txp$have_you_had_a_cough_with_phlegm_on_most_days_for_at_least_3_months_per_year_for_the_past_two_years
txp$cough_phlegm[txp$cough_phlegm == "" | txp$cough_yn == 0] = NA
```

#### Do you ever cough up blood?
```{r}
txp$cough_blood = txp$do_you_ever_cough_up_blood
txp$cough_blood[txp$cough_blood == "" | txp$cough_yn == 0] = NA
```

#### Do you get short of breath?
```{r}
txp$short_breath = txp$do_you_get_short_of_breath
txp$short_breath[txp$short_breath == ""] = NA
```



#### Number of Steps

```{r Recode N/A to NA}
txp$how_many_steps_can_you_climb_before_you_get_short_of_breath[txp$how_many_steps_can_you_climb_before_you_get_short_of_breath == "" | txp$how_many_steps_can_you_climb_before_you_get_short_of_breath == "N/A"] = NA
```

```{r}
txp$climb_steps = ifelse(txp$short_breath == 0 | txp$herlihy_questionnaire_complete == 0,
  NA,
  ifelse(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath %in%  c("4-5", "About 3"),
    1,
    ifelse(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath %in% c("after 5 steps","5-10"),
      2,
      ifelse(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath == "10 steps",
        3,
        ifelse(grepl("gillette",tolower(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath)),
          4,
          ifelse(grepl("flight",tolower(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath)),
            ifelse(as.integer(substr(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath,1,1)) > 1,
              4,
              3
            ),
            ifelse(substr(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath,1,1) %in% letters | substr(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath,1,1) %in% LETTERS, 
              -999,
              ifelse(as.integer(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath) >= 15,
                4,
                ifelse(as.integer(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath) >= 10,
                  3,
                  ifelse(as.integer(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath) >= 5,
                    2,
                    ifelse(as.integer(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath) <5 & as.integer(txp$how_many_steps_can_you_climb_before_you_get_short_of_breath) >= 0,
                      1,
                      -999
                    )
                  )
                )
              )
            )
          )
        )
      )
    )
  )
)
```

* 1st CHECK if txp$do_you_get_short_of_breath == 1
** IF yes then

*** 1st check For specific answers:
1. "5-10" >> 2
2. "About 3" >> 1
3. "lot" >> 4
4. "gillette" >> 4 
5. "after 5 steps" >> 2
6. "Don't know" >> 4

*** THEN IF answer contains "flights" then parse first 2 chars as digits - multiply by 10 (10 steps/flight)

*** OTHERWISE, extract first 2 chars as numeric

* 0 - 4 >> 1
* 5 - 9 >> 2
* 10 - 14 >> 3
* 15+ >> 4

** IF does not get SHORT OF BREATH, Then 

*** set REDCap$climb_steps = NA

#### For how long have you been short of breath?


# St. George's Respiratory Questionnaire - COPD version
## Symptoms
* sgrq_symptoms 1-4
* if answered, add +1 to response (matches new REDCap)

```{r Aligns Symptom questions ADDS 1}
loopOVER = c("sgrq_symptoms1","sgrq_sgrq_symptoms2","sgrq_symptoms3","sgrq_symptoms4","sgrq_sob1","sgrq_sob2","sgrq_sob3","sgrq_sob4","sgrq_sob5","sgrq_sob6","sgrq_sob7","sgrq_sob8","sgrq_sob9","sgrq_sob10","sgrq_sob11","sgrq_sob12","sgrq_sob13","sgrq_sob14","sgrq_sob15","sgrq_sob16","sgrq_sob17","sgrq_sob18","sgrq_sob19","sgrq_sob20","sgrq_sob21","sgrq_sob_treatments","sgrq_treatment1","sgrq_treatment2","sgrq_treatment3","sgrq_sob22","sgrq_sob23","sgrq_sob24","sgrq_sob25","sgrq_sob26","sgrq_sob27","sgrq_sob28","sgrq_sob29",
"sgrq_sob30","sgrq_sob31","sgrq_sob32","sgrq_sob33","sgrq_sob34","sgrq_sob35","sgrq_sob36")

for (varlist in loopOVER){
  txp[varlist] = as.factor(as.integer(txp[[varlist]]) +1)
}

```

```{r}
loopOVER = c("sgrqi_symptoms1", "sgrqi_symptoms2", "sgrqi_symptoms3", "sgrqi_symptoms4", "sgrqi_activities1", "sgrqi_activities2", "sgrqi_activities3", 
"sgrqi_activities4", "sgrqi_activities5", "sgrqi_activities6", "sgrqi_activities7", "sgrqi_activities8", "sgrqi_activities9", "sgrqi_activities10", "sgrqi_activities11",
"sgrqi_cough1", "sgrqi_cough2", "sgrqi_cough3", "sgrqi_cough4", 
"sgrqi_cough5", "sgrqi_cough6", "sgrqi_effects1", "sgrqi_effects2", "sgrqi_effects3", 
"sgrqi_effects4", "sgrqi_effects5", "sgrqi_effects6", "sgrqi_effects7", "sgrqi_effects8", "sgrqi_effects9", "sgrqi_effects10")

for (varlist in loopOVER){
  txp[varlist] = as.factor(as.integer(txp[[varlist]]) +1)
}
```


# SPECIFIC QUESTIONS
## Smoking 
* tobacco_history1___0 (EVER SMOKED BOX Clinical Genetics)
* tobacco_history1___1 (NEVER SMOKED BOX Clinical Genetics)

```{r Converts Smoking Status from checkbox to multiple choice}
txp$SmokingStatusOLD = ifelse(as.integer(txp$tobacco_history1___0) == 0 & as.integer(txp$tobacco_history1___1) == 0,
                              NA,
                              ifelse(as.integer(txp$tobacco_history1___0) == 1,
                                     1,
                                     0
                              )
)
```
### Recodes smokes status to "ever smoked" if affirmative on the following 
* have_you_ever_smoked_cigarettes (Herlihy)
* tobacco_history1___0 (EVER SMOKED BOX Clinical Genetics)
* tobacco_history1___1 (NEVER SMOKED BOX Clinical Genetics)

```{r Uses smoking info from either Herlihy and ClinGen Qs}
txp$SmokingStatusNEW = ifelse(is.na(txp$SmokingStatusOLD) & txp$have_you_ever_smoked_cigarettes == "",
                               NA,
                               ifelse((is.na(txp$SmokingStatusOLD) & txp$have_you_ever_smoked_cigarettes == "1") | (txp$SmokingStatusOLD == 1) | txp$have_you_ever_smoked_cigarettes == "1",
                                      1,
                                      0
                                      )
)
```

```{r QC of Smoking status}
print("Table of Smoking status in OLD REDCAP cohort")
table(txp$SmokingStatusNEW,useNA = "always")
```

* NA appears to indicate "NEVER" smoked
```{r Recodes EVER_NEVER smoking status BLANK to NEVER smoker}
txp$Smoking_NE = ifelse(is.na(txp$SmokingStatusNEW),
                        0,
                        ifelse(txp$SmokingStatusNEW == 1,
                                1,
                                0
                               )
                        )
```

```{r Recodes CURRENT SMOKING STATUS blank to not currently smoking}
txp$smoking_cigarettes_now = ifelse(is.na(txp$are_you_smoking_cigarettes_now) | txp$are_you_smoking_cigarettes_now == "" | txp$are_you_smoking_cigarettes_now == 0,
                                    0,
                                    1
)
```
```{r Uses 2 variables to inform as to pack history}
txp$on_average_how_many_packs_per_day_did_you_smoke[txp$on_average_how_many_packs_per_day_did_you_smoke %in% c("N/A","NA","","a couple in my whole life")] = NA
txp$tobacco_history3[txp$tobacco_history3 %in% c("N/A","NA","")] = NA
txp$AvgDailyCigSmoked = ifelse(is.na(txp$on_average_how_many_packs_per_day_did_you_smoke),
                               ifelse(is.na(txp$tobacco_history3),
                                  0,
                                  ifelse( gsub("[[:space:]]", "", txp$tobacco_history3) == "3packs/day", 
                                    60,
                                    as.numeric(gsub("\\D", "", txp$tobacco_history3))
                                  )
                                ),  
                                ifelse(gsub("[[:space:]]", "", txp$tobacco_history3) %in% c("11/2","1to2","1.5"),
                                         30,
                                         ifelse(gsub("[[:space:]]", "", txp$tobacco_history3) %in% c("10cigarettesperday", "Half","0.5"),
                                            10,
                                            ifelse(gsub("[[:space:]]", "", txp$tobacco_history3) == ".25packsaday", 5,
                                                ifelse(gsub("[[:space:]]", "", txp$tobacco_history3) == "2-2.5", 45,
                                                    ifelse(gsub("[[:space:]]", "", txp$tobacco_history3) == "2-3", 50,
                                                        ifelse(gsub("[[:space:]]", "", txp$tobacco_history3) == "lessthan1", 20,
                                                            ifelse(as.numeric(gsub("\\D", "", txp$tobacco_history3)) >= 10, 
                                                                as.numeric(gsub("\\D", "", txp$tobacco_history3)),
                                                                as.numeric(gsub("\\D", "", txp$tobacco_history3)) * 20
                                                            )
                                                        )
                                                      )
                                                  )
                                              )
                                          )
                                      )
                                  )
```



